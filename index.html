<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: gap: blob:">
    <title>فاتورة برو (إصدار 2025)</title>
    <script src="cordova.js"></script>
    <script src="https://unpkg.com/dexie@3.2.2/dist/dexie.min.js"></script>
    <style>
        /* === تصميم عصري وجذاب 2025 === */
        :root {
            --primary-color: #4361ee; --primary-dark: #3a53c4; --primary-gradient: linear-gradient(145deg, #4361ee 0%, #4895ef 100%);
            --accent-color: #f77f00; --success-color: #2a9d8f; --danger-color: #e63946; --text-dark: #1e2125;
            --text-light: #6c757d; --background-light: #f8f9fa; --background-white: #ffffff; --border-color: #e9ecef;
            --shadow-color: rgba(67, 97, 238, 0.1); --shadow-hover-color: rgba(67, 97, 238, 0.2);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
        body { background: var(--background-light); padding: 8px; font-size: 16px; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 1200px; margin: 0 auto; background: var(--background-white); border-radius: 20px; box-shadow: 0 8px 24px var(--shadow-color); overflow: hidden; border: 1px solid var(--border-color); }
        .header { background: var(--primary-gradient); color: white; padding: 28px; text-align: center; }
        .header h1 { font-size: 2rem; margin-bottom: 5px; text-shadow: 1px 1px 3px rgba(0,0,0,0.1); }
        .tabs { display: flex; background-color: var(--background-light); padding: 5px; border-bottom: 1px solid var(--border-color); }
        .tab { flex: 1; padding: 14px 10px; background: none; border: 0; border-radius: 12px; cursor: pointer; font-size: 1.05rem; font-weight: 700; color: var(--text-light); transition: all 0.3s ease; position: relative; }
        .tab.active { color: white; background: var(--primary-color); box-shadow: 0 4px 10px var(--shadow-color); transform: translateY(-2px); }
        .tab-content { display: none; padding: 24px; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .section-card { background: var(--background-white); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.02); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
        .form-group { position: relative; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-dark); font-size: 0.95rem; }
        input, select, textarea { width: 100%; padding: 14px; border: 1px solid var(--border-color); border-radius: 10px; font-size: 1rem; transition: all 0.2s ease; background: var(--background-light); font-family: inherit; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 4px var(--shadow-color); }
        .btn { color: white; border: none; padding: 14px 28px; border-radius: 10px; cursor: pointer; font-size: 1.05rem; font-weight: bold; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.15); }
        .btn:active { transform: scale(0.98) translateY(0); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn.primary { background: var(--primary-gradient); } .btn.success { background-color: var(--success-color); } .btn.danger { background-color: var(--danger-color); }
        .line-total { background: #e9ecef; padding: 10px; border-radius: 10px; font-weight: bold; color: var(--text-dark); text-align: center; display: flex; align-items: center; justify-content: center; min-height: 53px; font-size: 1.25rem; }
        .actions { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; padding: 10px 0; }
        .invoice-item { background: var(--background-white); padding: 18px; border-radius: 12px; box-shadow: 0 4px 15px var(--shadow-color); border-left: 6px solid var(--primary-color); margin-bottom: 15px; transition: all 0.2s ease; }
        .invoice-item:hover { transform: scale(1.02); box-shadow: 0 6px 20px var(--shadow-hover-color); }
        .invoice-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); gap: 10px; margin-top: 15px; }
        .tab-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .tab-header h2 { margin: 0; color: var(--text-dark); font-size: 1.6rem; }
        .tab-header .counter { background-color: var(--primary-color); color: white; padding: 6px 18px; border-radius: 20px; font-size: 1rem; font-weight: bold; }
        #product-suggestions { display: none; position: absolute; background-color: white; border: 1px solid var(--border-color); border-radius: 10px; width: 100%; max-height: 220px; overflow-y: auto; z-index: 1000; box-shadow: 0 8px 20px var(--shadow-color); top: 100%; left: 0; }
        .suggestion-item { padding: 14px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover, .suggestion-item.active { background-color: #eef2ff; }
        @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } .tab-header h2 { font-size: 1.4rem; } }
    </style>
</head>
<body>
    <div class="container">
        <header class="header"><h1>محلات ابو جعفر الرديني</h1><p>لتجارة المواد الغذائية والحلويات</p></header>
        <div class="tabs">
            <button class="tab active" onclick="switchTab('create', this)">➕ إنشاء فاتورة</button>
            <button class="tab" onclick="switchTab('saved', this)">🧾 الفواتير</button>
            <button class="tab" onclick="switchTab('products', this)">📦 المنتجات</button>
        </div>
        <main>
            <div id="create-tab" class="tab-content active"><section class="section-card"><div class="form-grid"><div class="form-group"><label for="customerName">اسم الزبون:</label><input type="text" id="customerName"></div><div class="form-group"><label for="invoiceDate">تاريخ الفاتورة:</label><input type="date" id="invoiceDate"></div></div></section><section class="section-card"><div class="form-grid" style="align-items: end;"><div class="form-group" style="grid-column: 1 / -1;"><label for="productName">اسم المنتج:</label><input type="text" id="productName" placeholder="اكتب للبحث..." autocomplete="off"><div id="product-suggestions"></div></div><div class="form-group"><label for="quantity">الكمية:</label><input type="number" id="quantity" inputmode="decimal"></div><div class="form-group"><label for="price">السعر:</label><input type="number" id="price" inputmode="numeric"></div><div class="form-group"><label>المجموع:</label><div class="line-total" id="lineTotal">0</div></div><div class="form-group" style="grid-column: 1 / -1;"><label for="itemNotes">ملاحظات المنتج (اختياري):</label><input type="text" id="itemNotes" placeholder="اضافة ملاحظات"></div></div><div style="text-align: center; margin-top: 20px;"><button id="addItemBtn" class="btn primary">➕ إضافة المنتج للفاتورة</button></div></section><div id="itemsContainerWrapper" class="section-card" style="display:none;"><table style="width:100%; border-collapse: collapse; text-align:center;"><thead><tr style="background: var(--primary-dark); color:white;"><th style="padding:12px;">#</th><th>المنتج</th><th>الكمية</th><th>السعر</th><th>المجموع</th><th>الملاحظات</th><th colspan="2">الإجراءات</th></tr></thead><tbody id="itemsContainer"></tbody></table></div><section class="section-card"><div class="form-grid"><div class="form-group"><label>إجمالي الفاتورة الحالية:</label><div id="currentTotalAmount" class="line-total">0 دينار</div></div><div class="form-group"><label>عدد المنتجات:</label><div id="itemCount" class="line-total">0</div></div><div class="form-group"><label for="previousBalance">الحساب السابق:</label><input type="number" id="previousBalance" inputmode="numeric"></div><div class="form-group"><label for="paymentAmount">المبلغ الواصل:</label><input type="number" id="paymentAmount" inputmode="numeric"></div></div><div class="form-group" style="margin-top: 20px;"><label style="font-size: 1.2rem;">المبلغ المتبقي النهائي:</label><div id="remainingAmount" class="line-total" style="font-size: 1.8rem; color: var(--danger-color); background: white; border: 2px solid var(--danger-color); font-weight: bold;">0 دينار</div></div></section><div class="actions"><button id="saveBtn" class="btn primary">💾 حفظ الفاتورة</button><button class="btn" style="background-color: #1a237e;" onclick="shareCurrentInvoice()">🔗 مشاركة</button><button class="btn danger" onclick="confirmClearInvoice()">🗑️ مسح</button></div></div>
            <div id="saved-tab" class="tab-content"><div class="tab-header"><h2>قائمة الفواتير</h2><span class="counter" id="invoicesCounter">0</span></div><div class="form-group" style="margin-bottom: 20px;"><label for="invoiceSearchInput">🔎 بحث عن فاتورة (باسم الزبون):</label><input type="search" id="invoiceSearchInput" placeholder="اكتب اسم الزبون للبحث..."></div><div class="actions"><button class="btn success" onclick="importInvoices()">🔼 استيراد فواتير</button><button class="btn" style="background-color: var(--primary-color)" onclick="exportInvoices()">🔽 تصدير فواتير</button><input type="file" id="import-invoices-file" accept=".json" style="display: none;"></div><div id="invoicesList" style="margin-top: 20px;"></div></div>
            <div id="products-tab" class="tab-content"><div class="tab-header"><h2>قائمة المنتجات</h2><span class="counter" id="productsCounter">0</span></div><div class="form-group" style="margin-bottom: 20px;"><label for="productSearchInput">🔎 بحث عن منتج:</label><input type="search" id="productSearchInput" placeholder="اكتب اسم المنتج للبحث..."></div><section class="section-card"><div class="form-grid"><div class="form-group"><label for="newProductName">اسم المنتج الجديد:</label><input type="text" id="newProductName"></div><div class="form-group"><label for="newProductPrice">سعر المنتج:</label><input type="number" id="newProductPrice" inputmode="numeric"></div></div><p style="text-align:center; font-size:0.8rem; color: var(--text-light); margin-top:10px;">اضغط "Enter" بعد إدخال السعر للإضافة السريعة</p></section><div id="productsListContainer" class="section-card"></div><div class="actions" style="margin-top:20px; justify-content:center;"><button class="btn success" onclick="importProducts()">🔼 استيراد منتجات</button><button class="btn" style="background-color: var(--primary-color)" onclick="exportProducts()">🔽 تصدير منتجات</button><button class="btn danger" onclick="clearAllProducts()">🗑️ مسح كل المنتجات</button><input type="file" id="import-products-file" accept=".json" style="display: none;"></div></div>
        </main>
    </div>

<script>
    // --- كل الكود هنا يبقى كما هو بدون تغيير ---
    document.addEventListener('deviceready', initializeApp, false);
    const db = new Dexie("InvoiceAppDB_Cordova_Final");
    db.version(1).stores({ invoices: '++id, customer, date', products: '++id, &name, price' });
    let currentInvoice = { items: [], total: 0, payment: 0, previousBalance: 0 };
    let currentEditingInvoiceId = null; let isEditingItem = false; let editingItemIndex = null; let allProductsCache = []; let allInvoicesCache = []; let productListCache = []; let listenersInitialized = false;
    if (typeof cordova === 'undefined') { document.addEventListener('DOMContentLoaded', initializeApp); }
    async function initializeApp() {if (window.StatusBar) {StatusBar.backgroundColorByHexString("#3a53c4");} await Promise.all([updateCounters(), displaySavedInvoices(), displaySavedProducts()]); setupEventListeners(); document.getElementById('invoiceDate').valueAsDate = new Date();}
    function setupEventListeners() {if (listenersInitialized) return; document.getElementById('saveBtn').addEventListener('click', saveOrUpdateInvoice); document.getElementById('addItemBtn').addEventListener('click', handleAddOrUpdateClick); document.getElementById('productName').addEventListener('input', handleProductSearch); document.getElementById('productName').addEventListener('blur', () => setTimeout(() => document.getElementById('product-suggestions').style.display = 'none', 200)); ['quantity', 'price'].forEach(id => document.getElementById(id).addEventListener('input', updateLineTotal)); ['previousBalance', 'paymentAmount'].forEach(id => document.getElementById(id).addEventListener('input', updateFinalTotals)); const handleEnterKey = (currentId, nextId, actionFn) => {document.getElementById(currentId).addEventListener('keydown', e => {if (e.key === 'Enter' || e.keyCode === 13) {e.preventDefault(); if (nextId) document.getElementById(nextId).focus(); else if (actionFn) actionFn();}});}; handleEnterKey('productName', 'quantity'); handleEnterKey('quantity', 'price'); handleEnterKey('price', 'itemNotes'); handleEnterKey('itemNotes', null, handleAddOrUpdateClick); handleEnterKey('newProductName', 'newProductPrice'); handleEnterKey('newProductPrice', null, saveProduct); document.getElementById('import-invoices-file').addEventListener('change', handleInvoiceImport); document.getElementById('import-products-file').addEventListener('change', handleProductImport); document.getElementById('invoiceSearchInput').addEventListener('input', handleInvoiceSearch); document.getElementById('productSearchInput').addEventListener('input', handleProductListSearch); listenersInitialized = true;}
    function switchTab(tabId, element) {document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.getElementById(`${tabId}-tab`).classList.add('active'); document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); element.classList.add('active');}
    function formatCurrency(num) { return (num || 0).toLocaleString('en-US', { maximumFractionDigits: 0 }); }
    function formatTime(date) { return date.toLocaleTimeString('ar-EG', { hour: 'numeric', minute: '2-digit', hour12: true }); }
    async function updateCounters() {const [invCount, prodCount] = await Promise.all([db.invoices.count(), db.products.count()]); document.getElementById('invoicesCounter').textContent = formatCurrency(invCount); document.getElementById('productsCounter').textContent = formatCurrency(prodCount);}
    async function handleProductSearch(e) {const suggestionsContainer = document.getElementById('product-suggestions'); const query = e.target.value.toLowerCase().trim(); suggestionsContainer.innerHTML = ''; if (query.length === 0) { suggestionsContainer.style.display = 'none'; return; } allProductsCache = await db.products.orderBy('name').toArray(); const filteredProducts = allProductsCache.filter(p => p.name.toLowerCase().includes(query)); if (filteredProducts.length > 0) {filteredProducts.slice(0, 10).forEach(product => {const item = document.createElement('div'); item.className = 'suggestion-item'; item.innerHTML = `${product.name} - <strong style="color:var(--success-color);">${formatCurrency(product.price)}</strong>`; item.onclick = () => selectProduct(product); suggestionsContainer.appendChild(item);}); suggestionsContainer.style.display = 'block';} else { suggestionsContainer.style.display = 'none'; }}
    function selectProduct(product) {document.getElementById('productName').value = product.name; document.getElementById('price').value = product.price; document.getElementById('product-suggestions').style.display = 'none'; document.getElementById('quantity').focus(); updateLineTotal();}
    async function saveProduct() {const nameInput = document.getElementById('newProductName'); const priceInput = document.getElementById('newProductPrice'); const name = nameInput.value.trim(); const price = parseFloat(priceInput.value) || 0; if (!name || price <= 0) return alert('يرجى إدخال اسم وسعر صحيح للمنتج.'); try {const existingProduct = await db.products.where('name').equalsIgnoreCase(name).first(); if (existingProduct) {if (confirm(`المنتج "${name}" موجود بالفعل. هل تريد تحديث سعره إلى ${formatCurrency(price)}؟`)) {await db.products.update(existingProduct.id, { price: price });} else {return;}} else {await db.products.add({ name, price });} await Promise.all([displaySavedProducts(), updateCounters()]); nameInput.value = ''; priceInput.value = ''; nameInput.focus();} catch (error) {console.error("Error saving product:", error); alert('حدث خطأ غير متوقع أثناء حفظ المنتج.');}}
    async function deleteProduct(id) { if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) { await db.products.delete(id); await Promise.all([displaySavedProducts(), updateCounters()]); } }
    function handleProductListSearch(e) {const query = e.target.value.toLowerCase().trim(); const filteredProducts = productListCache.filter(p => p.name.toLowerCase().includes(query)); renderProductsList(filteredProducts);}
    function renderProductsList(products) {const container = document.getElementById('productsListContainer'); container.innerHTML = ''; if (products.length === 0) {container.innerHTML = `<p style="text-align:center;color:var(--text-light);">لا توجد منتجات تطابق البحث.</p>`; return;} const table = document.createElement('table'); table.style.width = '100%'; table.style.borderCollapse = 'collapse'; table.innerHTML = `<thead><tr style="background:var(--primary-dark); color:white;"><th style="padding:10px;">المنتج</th><th>السعر</th><th>حذف</th></tr></thead><tbody>${products.map(p => `<tr><td style="padding:8px; border-bottom:1px solid #eee;">${p.name}</td><td style="padding:8px; border-bottom:1px solid #eee; color:var(--success-color); font-weight:bold;">${formatCurrency(p.price)}</td><td style="padding:8px; border-bottom:1px solid #eee; text-align:center;"><button class="btn danger" style="padding:5px 10px;" onclick="deleteProduct(${p.id})">🗑️</button></td></tr>`).join('')}</tbody>`; container.appendChild(table);}
    async function displaySavedProducts() {productListCache = await db.products.orderBy('name').toArray(); renderProductsList(productListCache);}
    function updateLineTotal() { const q = parseFloat(document.getElementById('quantity').value) || 0, p = parseFloat(document.getElementById('price').value) || 0; document.getElementById('lineTotal').textContent = formatCurrency(q * p); }
    function handleAddOrUpdateClick() {if (isEditingItem) {updateItemInInvoice();} else {addItemFromForm();}}
    async function addItemFromForm() {const productName = document.getElementById('productName').value.trim(); const quantity = parseFloat(document.getElementById('quantity').value) || 0; const price = parseFloat(document.getElementById('price').value) || 0; const notes = document.getElementById('itemNotes').value.trim(); if (!productName || quantity <= 0 || price <= 0) return alert('يرجى إدخال اسم المنتج وكمية وسعر صحيح.'); let productInDb = await db.products.where('name').equalsIgnoreCase(productName).first(); if (!productInDb) { await db.products.add({ name: productName, price: price }); await displaySavedProducts(); await updateCounters(); } else if (productInDb.price !== price) { await db.products.update(productInDb.id, { price: price }); await displaySavedProducts(); } currentInvoice.items.push({ product: productName, quantity, price, total: quantity * price, notes }); displayCurrentInvoiceItems(); updateFinalTotals(); ['productName', 'quantity', 'price', 'itemNotes'].forEach(id => document.getElementById(id).value = ''); document.getElementById('lineTotal').textContent = '0'; document.getElementById('productName').focus();}
    function editItem(index) {const item = currentInvoice.items[index]; if (!item) return; isEditingItem = true; editingItemIndex = index; document.getElementById('productName').value = item.product; document.getElementById('quantity').value = item.quantity; document.getElementById('price').value = item.price; document.getElementById('itemNotes').value = item.notes || ''; updateLineTotal(); document.getElementById('addItemBtn').textContent = '✏️ تحديث المنتج'; window.scrollTo(0, document.getElementById('productName').offsetTop);}
    function updateItemInInvoice() {const productName = document.getElementById('productName').value.trim(); const quantity = parseFloat(document.getElementById('quantity').value) || 0; const price = parseFloat(document.getElementById('price').value) || 0; const notes = document.getElementById('itemNotes').value.trim(); if (!productName || quantity <= 0 || price <= 0) return alert('يرجى إدخال اسم المنتج وكمية وسعر صحيح.'); currentInvoice.items[editingItemIndex] = { product: productName, quantity, price, total: quantity * price, notes }; isEditingItem = false; editingItemIndex = null; displayCurrentInvoiceItems(); updateFinalTotals(); ['productName', 'quantity', 'price', 'itemNotes'].forEach(id => document.getElementById(id).value = ''); document.getElementById('lineTotal').textContent = '0'; document.getElementById('addItemBtn').textContent = '➕ إضافة المنتج للفاتورة'; document.getElementById('productName').focus();}
    function removeItem(index) { currentInvoice.items.splice(index, 1); displayCurrentInvoiceItems(); updateFinalTotals(); }
    function updateFinalTotals() {const currentTotal = currentInvoice.items.reduce((s, i) => s + i.total, 0); const prevBal = parseFloat(document.getElementById('previousBalance').value) || 0; const payment = parseFloat(document.getElementById('paymentAmount').value) || 0; const remaining = (currentTotal + prevBal) - payment; currentInvoice.total = currentTotal; currentInvoice.previousBalance = prevBal; currentInvoice.payment = payment; document.getElementById('itemCount').textContent = formatCurrency(currentInvoice.items.length); document.getElementById('currentTotalAmount').textContent = `${formatCurrency(currentTotal)} دينار`; document.getElementById('remainingAmount').textContent = `${formatCurrency(remaining)} دينار`;}
    function displayCurrentInvoiceItems() {document.getElementById('itemsContainerWrapper').style.display = currentInvoice.items.length > 0 ? 'block' : 'none'; const container = document.getElementById('itemsContainer'); container.innerHTML = currentInvoice.items.map((item, i) => `<tr><td style="padding:8px; border-bottom:1px solid #eee;">${formatCurrency(i + 1)}</td><td style="text-align:right; padding:8px; border-bottom:1px solid #eee;">${item.product}</td><td style="padding:8px; border-bottom:1px solid #eee;">${item.quantity}</td><td style="padding:8px; border-bottom:1px solid #eee;">${formatCurrency(item.price)}</td><td style="padding:8px; border-bottom:1px solid #eee; font-weight:bold;">${formatCurrency(item.total)}</td><td style="padding:8px; border-bottom:1px solid #eee;">${item.notes || '-'}</td><td style="padding:8px; border-bottom:1px solid #eee;"><button class="btn success" style="padding:5px 10px;" onclick="editItem(${i})">✏️</button></td><td style="padding:8px; border-bottom:1px solid #eee;"><button class="btn danger" style="padding:5px 10px;" onclick="removeItem(${i})">🗑️</button></td></tr>`).join('');}
    async function saveOrUpdateInvoice() {const customerName = document.getElementById('customerName').value.trim(); if (!customerName) return alert('يرجى إدخال اسم الزبون.'); if (currentInvoice.items.length === 0) return alert('لا يمكن حفظ فاتورة فارغة.'); updateFinalTotals(); const data = { customer: customerName, date: document.getElementById('invoiceDate').value, ...currentInvoice }; if (currentEditingInvoiceId) { await db.invoices.update(currentEditingInvoiceId, data); alert('تم تحديث الفاتورة بنجاح!'); } else { await db.invoices.add(data); alert('تم حفظ الفاتورة بنجاح!'); } await Promise.all([displaySavedInvoices(), updateCounters()]); clearInvoice();}
    async function editInvoice(id) {const invoice = await db.invoices.get(id); if (!invoice) return; currentEditingInvoiceId = id; document.getElementById('customerName').value = invoice.customer; document.getElementById('invoiceDate').value = invoice.date; document.getElementById('previousBalance').value = invoice.previousBalance || ''; document.getElementById('paymentAmount').value = invoice.payment || ''; currentInvoice = { items: invoice.items, total: invoice.total, payment: invoice.payment, previousBalance: invoice.previousBalance, }; displayCurrentInvoiceItems(); updateFinalTotals(); document.getElementById('saveBtn').textContent = '✏️ تحديث الفاتورة'; switchTab('create', document.querySelector('.tab')); window.scrollTo(0, 0);}
    async function deleteInvoice(id) { if (confirm('هل أنت متأكد من حذف هذه الفاتورة؟')) { await db.invoices.delete(id); await Promise.all([displaySavedInvoices(), updateCounters()]); } }
    function handleInvoiceSearch(e) {const query = e.target.value.toLowerCase().trim(); const filteredInvoices = allInvoicesCache.filter(inv => inv.customer.toLowerCase().includes(query)); renderInvoices(filteredInvoices);}
    function renderInvoices(invoices) {const list = document.getElementById('invoicesList'); list.innerHTML = ''; if (invoices.length === 0) { list.innerHTML = `<p style="text-align:center;color:var(--text-light);padding:20px;">لا توجد فواتير تطابق البحث.</p>`; return; } invoices.forEach(inv => {const grandTotal = (inv.total || 0) + (inv.previousBalance || 0); const remaining = grandTotal - (inv.payment || 0); const item = document.createElement('div'); item.className = 'invoice-item'; item.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:flex-start;"><div><strong>👤 ${inv.customer}</strong><div style="font-size:0.9em; color:var(--text-light);">📅 ${inv.date}</div></div><div style="text-align:left;"><div style="font-weight:bold; color:var(--danger-color);">المتبقي: ${formatCurrency(remaining)}</div><small>الإجمالي: ${formatCurrency(grandTotal)}</small></div></div><div class="invoice-actions"><button class="btn" style="background-color: var(--primary-color);" onclick="printInvoice(${inv.id})">🖨️ طباعة</button><button class="btn" style="background-color: var(--accent-color); color: #000;" onclick="editInvoice(${inv.id})">✏️ تعديل</button><button class="btn danger" onclick="deleteInvoice(${inv.id})">🗑️ حذف</button></div>`; list.appendChild(item);});}
    async function displaySavedInvoices() {allInvoicesCache = await db.invoices.orderBy('id').reverse().toArray(); renderInvoices(allInvoicesCache);}
    function confirmClearInvoice() { if (currentInvoice.items.length > 0 && confirm('هل أنت متأكد من مسح جميع حقول الفاتورة الحالية؟')) clearInvoice(); else if (currentInvoice.items.length === 0) clearInvoice(); }
    function clearInvoice() {currentEditingInvoiceId = null; isEditingItem = false; editingItemIndex = null; ['customerName', 'previousBalance', 'paymentAmount', 'productName', 'quantity', 'price', 'itemNotes'].forEach(id => document.getElementById(id).value = ''); document.getElementById('invoiceDate').valueAsDate = new Date(); currentInvoice = { items: [], total: 0, payment: 0, previousBalance: 0 }; displayCurrentInvoiceItems(); updateFinalTotals(); document.getElementById('saveBtn').textContent = '💾 حفظ الفاتورة'; document.getElementById('addItemBtn').textContent = '➕ إضافة المنتج للفاتورة';}
    async function exportInvoices() {const invoices = await db.invoices.toArray(); if (invoices.length === 0) return alert("لا توجد فواتير لتصديرها."); const data = { invoices }; const dataStr = JSON.stringify(data, null, 2); const fileName = "invoices_backup_" + new Date().toISOString().slice(0, 10) + ".json"; await shareOrDownload(dataStr, fileName, 'application/json');}
    function importInvoices() { document.getElementById('import-invoices-file').click(); }
    function handleInvoiceImport(event) {const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => processInvoiceImport(e.target.result); reader.readAsText(file); event.target.value = '';}
    async function processInvoiceImport(dataStr) {if (!confirm("سيتم استيراد الفواتير الجديدة ومسح جميع الفواتير الحالية. لن تتأثر قائمة المنتجات. هل أنت متأكد؟")) return; try {const importedData = JSON.parse(dataStr); if (!importedData.invoices) throw new Error("الملف غير صالح."); await db.transaction('rw', db.invoices, async () => {await db.invoices.clear(); await db.invoices.bulkAdd(importedData.invoices.map(i => { delete i.id; return i; }));}); await initializeApp(); alert("تم استيراد الفواتير بنجاح!");} catch (error) { console.error('Import Error:', error); alert("فشل استيراد الملف."); }}
    async function exportProducts() {const products = await db.products.toArray(); if (products.length === 0) return alert("لا توجد منتجات لتصديرها."); const data = { products }; const dataStr = JSON.stringify(data, null, 2); const fileName = "products_backup_" + new Date().toISOString().slice(0, 10) + ".json"; await shareOrDownload(dataStr, fileName, 'application/json');}
    function importProducts() { document.getElementById('import-products-file').click(); }
    function handleProductImport(event) {const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => processProductImport(e.target.result); reader.readAsText(file); event.target.value = '';}
    async function processProductImport(dataStr) {if (!confirm("سيتم استيراد المنتجات الجديدة ومسح جميع المنتجات الحالية. لن تتأثر قائمة الفواتير. هل أنت متأكد؟")) return; try {const importedData = JSON.parse(dataStr); if (!importedData.products) throw new Error("الملف غير صالح."); await db.transaction('rw', db.products, async () => {await db.products.clear(); await db.products.bulkAdd(importedData.products.map(p => { delete p.id; return p; }));}); await initializeApp(); alert("تم استيراد المنتجات بنجاح!");} catch (error) { console.error('Import Error:', error); alert("فشل استيراد الملف."); }}
    async function clearAllProducts() {if (confirm('هل أنت متأكد من حذف جميع المنتجات؟ هذا الإجراء لا يمكن التراجع عنه.')) {await db.products.clear(); await displaySavedProducts(); await updateCounters(); alert('تم حذف جميع المنتجات.');}}
    async function shareOrDownload(dataStr, fileName, mimeType) {if (window.plugins && window.plugins.socialsharing) {const blob = new Blob([dataStr], { type: mimeType }); const reader = new FileReader(); reader.onloadend = function() {const base64data = reader.result; window.plugins.socialsharing.share(`ملف النسخ الاحتياطي: ${fileName}`, fileName, base64data, null, () => { console.log('تمت المشاركة بنجاح'); }, (err) => { alert('فشلت المشاركة: ' + err); });}; reader.readAsDataURL(blob);} else {alert("ميزة المشاركة المباشرة تعمل فقط على الهاتف. سيتم محاولة تنزيل الملف."); const blob = new Blob([dataStr], { type: mimeType }); try {const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = fileName; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);} catch(err) { console.error('Fallback download failed:', err); alert("فشل تنزيل الملف."); }}}
    async function shareCurrentInvoice() {if (currentInvoice.items.length === 0) return alert('يرجى تعبئة الفاتورة أولاً لمشاركتها.'); updateFinalTotals(); const customerName = document.getElementById('customerName').value.trim() || 'زبون'; const remaining = (currentInvoice.total + currentInvoice.previousBalance) - currentInvoice.payment; let shareText = `فاتورة: *${customerName}*\nالتاريخ: ${document.getElementById('invoiceDate').value}\n------------------------------------\n`; currentInvoice.items.forEach(item => {let itemText = `${item.product} (${item.quantity} x ${formatCurrency(item.price)}) = *${formatCurrency(item.total)}*`; if (item.notes) { itemText += `\n   - _ملاحظة: ${item.notes}_`; } shareText += itemText + '\n';}); shareText += `------------------------------------\nالمجموع: ${formatCurrency(currentInvoice.total)}\nحساب سابق: ${formatCurrency(currentInvoice.previousBalance)}\nالواصل: ${formatCurrency(currentInvoice.payment)}\n*المتبقي: ${formatCurrency(remaining)}*\n`; if (window.plugins && window.plugins.socialsharing) {window.plugins.socialsharing.share(shareText);} else {navigator.clipboard.writeText(shareText).then(() => {alert('تم نسخ تفاصيل الفاتورة. يمكنك الآن لصقها في أي تطبيق.');}, () => {alert('فشل نسخ الفاتورة.');});}}

    // =========================================================================
    // ============== الدالة النهائية والمضمونة للطباعة (v4) ==============
    // =========================================================================
    async function printInvoice(invoiceId) {
        // الخطوة 1: جلب بيانات الفاتورة من قاعدة البيانات (بدون تغيير)
        const invoice = await db.invoices.get(invoiceId);
        if (!invoice) {
            console.error("فشلت الطباعة: لم يتم العثور على الفاتورة بالمعرف:", invoiceId);
            alert("خطأ: لا يمكن العثور على الفاتورة المحددة للطباعة.");
            return;
        }

        const remaining = ((invoice.total || 0) + (invoice.previousBalance || 0)) - (invoice.payment || 0);
        const currentTime = formatTime(new Date());
        
        // الخطوة 2: بناء كود HTML كـ "نص" عادي (بدون تغيير)
        const printContent = `
        <!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><title>فاتورة ${formatCurrency(invoice.id)}</title>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');
            @page { size: A4; margin: 10mm; }
            body { font-family: 'Tajawal', sans-serif; direction: rtl; margin: 0; padding: 0; font-size: 11pt; line-height: 1.4; color: #000; }
            .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 5px; margin-bottom: 10px; } .header h1 { margin: 0; font-size: 18pt; font-weight: bold; } .header p { margin: 2px 0; font-size: 10pt; }
            .details-section { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; font-size: 12pt; border-bottom: 1px dashed #666; margin-bottom: 10px; }
            .items-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; } .items-table thead { display: table-header-group; } .items-table th, .items-table td { border: 1px solid #999; padding: 5px; text-align: center; }
            .items-table tr { page-break-inside: avoid; } .items-table th { font-weight: bold; background-color: #f0f0f0; } .items-table .item-name { text-align: right; padding-right: 8px; }
            .footer { page-break-inside: avoid; padding-top: 15px; border-top: 2px solid #333; margin-top: 15px; }
            .summary-table { width: 50%; margin-left: auto; font-size: 12pt; border-collapse: collapse; } .summary-table td { padding: 4px 6px; } .summary-table .label { font-weight: bold; }
            .summary-table .final-amount td { font-weight: bold; font-size: 14pt; border-top: 1px solid #666; padding-top: 6px; }
        </style></head><body>
            <header class="header"><h1>محلات ابو جعفر الرديني</h1><p>جعفر الرديني: <strong>07731103122 | 07800379300</strong>  - حسين الرديني: <strong>07826342265</strong></p><p><strong>العنوان:</strong> بلدروز - مقابل مطعم - بغداد - داخل القيصريه</p></header>
            <section class="details-section"><div><strong>الزبون:</strong> ${invoice.customer}</div><div><strong>التاريخ:</strong> ${invoice.date} | <strong>الوقت:</strong> ${currentTime}</div></section>
            <main>
                <table class="items-table">
                    <thead><tr><th>ت</th><th>اسم المنتج</th><th>الكمية</th><th>السعر</th><th>المبلغ</th><th>الملاحظات</th></tr></thead>
                    <tbody>${invoice.items.map((item, index) => `<tr><td>${index + 1}</td><td class="item-name">${item.product}</td><td>${item.quantity}</td><td>${formatCurrency(item.price)}</td><td>${formatCurrency(item.total)}</td><td>${item.notes || ''}</td></tr>`).join('')}</tbody>
                </table>
            </main>
            <footer class="footer">
                <table class="summary-table">
                    <tr><td class="label">مجموع الفاتورة:</td><td>${formatCurrency(invoice.total || 0)}</td></tr>
                    <tr><td class="label">الحساب السابق:</td><td>${formatCurrency(invoice.previousBalance || 0)}</td></tr>
                    <tr><td class="label">المبلغ الواصل:</td><td>${formatCurrency(invoice.payment || 0)}</td></tr>
                    <tr class="final-amount"><td class="label">المبلغ المتبقي:</td><td>${formatCurrency(remaining)}</td></tr>
                </table>
            </footer>
        </body></html>`;

        // الخطوة 3: التحقق من وجود إضافة الطباعة
        if (window.cordova && cordova.plugins && cordova.plugins.printer) {
            
            // ==========================[ الحل الجذري هنا ]==========================
            // لقد تم حذف كل كود الـ "iframe" المعقد والذي كان يسبب كل المشاكل.
            // الآن، نقوم بتمرير متغير "printContent" (الذي هو نص HTML) مباشرة إلى الإضافة.
            // هذه هي الطريقة الأصح والأكثر استقراراً ومباشرة.
            // ======================================================================
            cordova.plugins.printer.print(printContent, {
                name: `فاتورة ${invoice.id}`,
                orientation: 'portrait'
            }, function (res) {
                // هذا الجزء يعمل بعد إغلاق نافذة الطباعة
                console.log(res ? 'تم إرسال أمر الطباعة بنجاح' : 'تم إلغاء الطباعة من قبل المستخدم');
            });

        } else {
            // هذا الكود سيعمل كبديل في حال تشغيل التطبيق على متصفح الكمبيوتر
            alert("ميزة الطباعة المباشرة تعمل فقط على الهاتف. سيتم فتح نافذة طباعة المتصفح.");
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus(); // ضروري لبعض المتصفحات
            setTimeout(function(){ printWindow.print(); }, 500); // تأخير بسيط لضمان تحميل المحتوى
        }
    }
</script>
</body>
</html>

