<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: gap: blob:">
    <title>ÙØ§ØªÙˆØ±Ø© Ø¨Ø±Ùˆ (Ø¥ØµØ¯Ø§Ø± 2025)</title>
    <script src="cordova.js"></script>
    <script src="https://unpkg.com/dexie@3.2.2/dist/dexie.min.js"></script>
    <style>
        /* === ØªØµÙ…ÙŠÙ… Ø¹ØµØ±ÙŠ ÙˆØ¬Ø°Ø§Ø¨ 2025 === */
        :root {
            --primary-color: #4361ee; --primary-dark: #3a53c4; --primary-gradient: linear-gradient(145deg, #4361ee 0%, #4895ef 100%);
            --accent-color: #f77f00; --success-color: #2a9d8f; --danger-color: #e63946; --text-dark: #1e2125;
            --text-light: #6c757d; --background-light: #f8f9fa; --background-white: #ffffff; --border-color: #e9ecef;
            --shadow-color: rgba(67, 97, 238, 0.1); --shadow-hover-color: rgba(67, 97, 238, 0.2);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
        body { background: var(--background-light); padding: 8px; font-size: 16px; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 1200px; margin: 0 auto; background: var(--background-white); border-radius: 20px; box-shadow: 0 8px 24px var(--shadow-color); overflow: hidden; border: 1px solid var(--border-color); }
        .header { background: var(--primary-gradient); color: white; padding: 28px; text-align: center; }
        .header h1 { font-size: 2rem; margin-bottom: 5px; text-shadow: 1px 1px 3px rgba(0,0,0,0.1); }
        .tabs { display: flex; background-color: var(--background-light); padding: 5px; border-bottom: 1px solid var(--border-color); }
        .tab { flex: 1; padding: 14px 10px; background: none; border: 0; border-radius: 12px; cursor: pointer; font-size: 1.05rem; font-weight: 700; color: var(--text-light); transition: all 0.3s ease; position: relative; }
        .tab.active { color: white; background: var(--primary-color); box-shadow: 0 4px 10px var(--shadow-color); transform: translateY(-2px); }
        .tab-content { display: none; padding: 24px; }
        .tab-content.active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .section-card { background: var(--background-white); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.02); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
        .form-group { position: relative; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-dark); font-size: 0.95rem; }
        input, select, textarea { width: 100%; padding: 14px; border: 1px solid var(--border-color); border-radius: 10px; font-size: 1rem; transition: all 0.2s ease; background: var(--background-light); font-family: inherit; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 4px var(--shadow-color); }
        .btn { color: white; border: none; padding: 14px 28px; border-radius: 10px; cursor: pointer; font-size: 1.05rem; font-weight: bold; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.15); }
        .btn:active { transform: scale(0.98) translateY(0); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn.primary { background: var(--primary-gradient); } .btn.success { background-color: var(--success-color); } .btn.danger { background-color: var(--danger-color); }
        .line-total { background: #e9ecef; padding: 10px; border-radius: 10px; font-weight: bold; color: var(--text-dark); text-align: center; display: flex; align-items: center; justify-content: center; min-height: 53px; font-size: 1.25rem; }
        .actions { display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; padding: 10px 0; }
        .invoice-item { background: var(--background-white); padding: 18px; border-radius: 12px; box-shadow: 0 4px 15px var(--shadow-color); border-left: 6px solid var(--primary-color); margin-bottom: 15px; transition: all 0.2s ease; }
        .invoice-item:hover { transform: scale(1.02); box-shadow: 0 6px 20px var(--shadow-hover-color); }
        .invoice-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); gap: 10px; margin-top: 15px; }
        .tab-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .tab-header h2 { margin: 0; color: var(--text-dark); font-size: 1.6rem; }
        .tab-header .counter { background-color: var(--primary-color); color: white; padding: 6px 18px; border-radius: 20px; font-size: 1rem; font-weight: bold; }
        #product-suggestions { display: none; position: absolute; background-color: white; border: 1px solid var(--border-color); border-radius: 10px; width: 100%; max-height: 220px; overflow-y: auto; z-index: 1000; box-shadow: 0 8px 20px var(--shadow-color); top: 100%; left: 0; }
        .suggestion-item { padding: 14px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:hover, .suggestion-item.active { background-color: #eef2ff; }
        @media (max-width: 768px) { .form-grid { grid-template-columns: 1fr; } .tab-header h2 { font-size: 1.4rem; } }
    </style>
</head>
<body>
    <div class="container">
        <header class="header"><h1>Ù…Ø­Ù„Ø§Øª Ø§Ø¨Ùˆ Ø¬Ø¹ÙØ± Ø§Ù„Ø±Ø¯ÙŠÙ†ÙŠ</h1><p>Ù„ØªØ¬Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ© ÙˆØ§Ù„Ø­Ù„ÙˆÙŠØ§Øª</p></header>
        <div class="tabs">
            <button class="tab active" onclick="switchTab('create', this)">â• Ø¥Ù†Ø´Ø§Ø¡ ÙØ§ØªÙˆØ±Ø©</button>
            <button class="tab" onclick="switchTab('saved', this)">ğŸ§¾ Ø§Ù„ÙÙˆØ§ØªÙŠØ±</button>
            <button class="tab" onclick="switchTab('products', this)">ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button>
        </div>
        <main>
            <div id="create-tab" class="tab-content active"><section class="section-card"><div class="form-grid"><div class="form-group"><label for="customerName">Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†:</label><input type="text" id="customerName"></div><div class="form-group"><label for="invoiceDate">ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</label><input type="date" id="invoiceDate"></div></div></section><section class="section-card"><div class="form-grid" style="align-items: end;"><div class="form-group" style="grid-column: 1 / -1;"><label for="productName">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:</label><input type="text" id="productName" placeholder="Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø«..." autocomplete="off"><div id="product-suggestions"></div></div><div class="form-group"><label for="quantity">Ø§Ù„ÙƒÙ…ÙŠØ©:</label><input type="number" id="quantity" inputmode="decimal"></div><div class="form-group"><label for="price">Ø§Ù„Ø³Ø¹Ø±:</label><input type="number" id="price" inputmode="numeric"></div><div class="form-group"><label>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹:</label><div class="line-total" id="lineTotal">0</div></div><div class="form-group" style="grid-column: 1 / -1;"><label for="itemNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label><input type="text" id="itemNotes" placeholder="Ø§Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø§Øª"></div></div><div style="text-align: center; margin-top: 20px;"><button id="addItemBtn" class="btn primary">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„ÙØ§ØªÙˆØ±Ø©</button></div></section><div id="itemsContainerWrapper" class="section-card" style="display:none;"><table style="width:100%; border-collapse: collapse; text-align:center;"><thead><tr style="background: var(--primary-dark); color:white;"><th style="padding:12px;">#</th><th>Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th colspan="2">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody id="itemsContainer"></tbody></table></div><section class="section-card"><div class="form-grid"><div class="form-group"><label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</label><div id="currentTotalAmount" class="line-total">0 Ø¯ÙŠÙ†Ø§Ø±</div></div><div class="form-group"><label>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:</label><div id="itemCount" class="line-total">0</div></div><div class="form-group"><label for="previousBalance">Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø§Ø¨Ù‚:</label><input type="number" id="previousBalance" inputmode="numeric"></div><div class="form-group"><label for="paymentAmount">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙˆØ§ØµÙ„:</label><input type="number" id="paymentAmount" inputmode="numeric"></div></div><div class="form-group" style="margin-top: 20px;"><label style="font-size: 1.2rem;">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</label><div id="remainingAmount" class="line-total" style="font-size: 1.8rem; color: var(--danger-color); background: white; border: 2px solid var(--danger-color); font-weight: bold;">0 Ø¯ÙŠÙ†Ø§Ø±</div></div></section><div class="actions"><button id="saveBtn" class="btn primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</button><button class="btn" style="background-color: #1a237e;" onclick="shareCurrentInvoice()">ğŸ”— Ù…Ø´Ø§Ø±ÙƒØ©</button><button class="btn danger" onclick="confirmClearInvoice()">ğŸ—‘ï¸ Ù…Ø³Ø­</button></div></div>
            <div id="saved-tab" class="tab-content"><div class="tab-header"><h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h2><span class="counter" id="invoicesCounter">0</span></div><div class="form-group" style="margin-bottom: 20px;"><label for="invoiceSearchInput">ğŸ” Ø¨Ø­Ø« Ø¹Ù† ÙØ§ØªÙˆØ±Ø© (Ø¨Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†):</label><input type="search" id="invoiceSearchInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ† Ù„Ù„Ø¨Ø­Ø«..."></div><div class="actions"><button class="btn success" onclick="importInvoices()">ğŸ”¼ Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙÙˆØ§ØªÙŠØ±</button><button class="btn" style="background-color: var(--primary-color)" onclick="exportInvoices()">ğŸ”½ ØªØµØ¯ÙŠØ± ÙÙˆØ§ØªÙŠØ±</button><input type="file" id="import-invoices-file" accept=".json" style="display: none;"></div><div id="invoicesList" style="margin-top: 20px;"></div></div>
            <div id="products-tab" class="tab-content"><div class="tab-header"><h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2><span class="counter" id="productsCounter">0</span></div><div class="form-group" style="margin-bottom: 20px;"><label for="productSearchInput">ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬:</label><input type="search" id="productSearchInput" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ø¨Ø­Ø«..."></div><section class="section-card"><div class="form-grid"><div class="form-group"><label for="newProductName">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯:</label><input type="text" id="newProductName"></div><div class="form-group"><label for="newProductPrice">Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬:</label><input type="number" id="newProductPrice" inputmode="numeric"></div></div><p style="text-align:center; font-size:0.8rem; color: var(--text-light); margin-top:10px;">Ø§Ø¶ØºØ· "Enter" Ø¨Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø³Ø¹Ø± Ù„Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</p></section><div id="productsListContainer" class="section-card"></div><div class="actions" style="margin-top:20px; justify-content:center;"><button class="btn success" onclick="importProducts()">ğŸ”¼ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù†ØªØ¬Ø§Øª</button><button class="btn" style="background-color: var(--primary-color)" onclick="exportProducts()">ğŸ”½ ØªØµØ¯ÙŠØ± Ù…Ù†ØªØ¬Ø§Øª</button><button class="btn danger" onclick="clearAllProducts()">ğŸ—‘ï¸ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</button><input type="file" id="import-products-file" accept=".json" style="display: none;"></div></div>
        </main>
    </div>

<script>
    // --- ÙƒÙ„ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§ ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± ---
    document.addEventListener('deviceready', initializeApp, false);
    const db = new Dexie("InvoiceAppDB_Cordova_Final");
    db.version(1).stores({ invoices: '++id, customer, date', products: '++id, &name, price' });
    let currentInvoice = { items: [], total: 0, payment: 0, previousBalance: 0 };
    let currentEditingInvoiceId = null; let isEditingItem = false; let editingItemIndex = null; let allProductsCache = []; let allInvoicesCache = []; let productListCache = []; let listenersInitialized = false;
    if (typeof cordova === 'undefined') { document.addEventListener('DOMContentLoaded', initializeApp); }
    async function initializeApp() {if (window.StatusBar) {StatusBar.backgroundColorByHexString("#3a53c4");} await Promise.all([updateCounters(), displaySavedInvoices(), displaySavedProducts()]); setupEventListeners(); document.getElementById('invoiceDate').valueAsDate = new Date();}
    function setupEventListeners() {if (listenersInitialized) return; document.getElementById('saveBtn').addEventListener('click', saveOrUpdateInvoice); document.getElementById('addItemBtn').addEventListener('click', handleAddOrUpdateClick); document.getElementById('productName').addEventListener('input', handleProductSearch); document.getElementById('productName').addEventListener('blur', () => setTimeout(() => document.getElementById('product-suggestions').style.display = 'none', 200)); ['quantity', 'price'].forEach(id => document.getElementById(id).addEventListener('input', updateLineTotal)); ['previousBalance', 'paymentAmount'].forEach(id => document.getElementById(id).addEventListener('input', updateFinalTotals)); const handleEnterKey = (currentId, nextId, actionFn) => {document.getElementById(currentId).addEventListener('keydown', e => {if (e.key === 'Enter' || e.keyCode === 13) {e.preventDefault(); if (nextId) document.getElementById(nextId).focus(); else if (actionFn) actionFn();}});}; handleEnterKey('productName', 'quantity'); handleEnterKey('quantity', 'price'); handleEnterKey('price', 'itemNotes'); handleEnterKey('itemNotes', null, handleAddOrUpdateClick); handleEnterKey('newProductName', 'newProductPrice'); handleEnterKey('newProductPrice', null, saveProduct); document.getElementById('import-invoices-file').addEventListener('change', handleInvoiceImport); document.getElementById('import-products-file').addEventListener('change', handleProductImport); document.getElementById('invoiceSearchInput').addEventListener('input', handleInvoiceSearch); document.getElementById('productSearchInput').addEventListener('input', handleProductListSearch); listenersInitialized = true;}
    function switchTab(tabId, element) {document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.getElementById(`${tabId}-tab`).classList.add('active'); document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); element.classList.add('active');}
    function formatCurrency(num) { return (num || 0).toLocaleString('en-US', { maximumFractionDigits: 0 }); }
    function formatTime(date) { return date.toLocaleTimeString('ar-EG', { hour: 'numeric', minute: '2-digit', hour12: true }); }
    async function updateCounters() {const [invCount, prodCount] = await Promise.all([db.invoices.count(), db.products.count()]); document.getElementById('invoicesCounter').textContent = formatCurrency(invCount); document.getElementById('productsCounter').textContent = formatCurrency(prodCount);}
    async function handleProductSearch(e) {const suggestionsContainer = document.getElementById('product-suggestions'); const query = e.target.value.toLowerCase().trim(); suggestionsContainer.innerHTML = ''; if (query.length === 0) { suggestionsContainer.style.display = 'none'; return; } allProductsCache = await db.products.orderBy('name').toArray(); const filteredProducts = allProductsCache.filter(p => p.name.toLowerCase().includes(query)); if (filteredProducts.length > 0) {filteredProducts.slice(0, 10).forEach(product => {const item = document.createElement('div'); item.className = 'suggestion-item'; item.innerHTML = `${product.name} - <strong style="color:var(--success-color);">${formatCurrency(product.price)}</strong>`; item.onclick = () => selectProduct(product); suggestionsContainer.appendChild(item);}); suggestionsContainer.style.display = 'block';} else { suggestionsContainer.style.display = 'none'; }}
    function selectProduct(product) {document.getElementById('productName').value = product.name; document.getElementById('price').value = product.price; document.getElementById('product-suggestions').style.display = 'none'; document.getElementById('quantity').focus(); updateLineTotal();}
    async function saveProduct() {const nameInput = document.getElementById('newProductName'); const priceInput = document.getElementById('newProductPrice'); const name = nameInput.value.trim(); const price = parseFloat(priceInput.value) || 0; if (!name || price <= 0) return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ÙˆØ³Ø¹Ø± ØµØ­ÙŠØ­ Ù„Ù„Ù…Ù†ØªØ¬.'); try {const existingProduct = await db.products.where('name').equalsIgnoreCase(name).first(); if (existingProduct) {if (confirm(`Ø§Ù„Ù…Ù†ØªØ¬ "${name}" Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„. Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ­Ø¯ÙŠØ« Ø³Ø¹Ø±Ù‡ Ø¥Ù„Ù‰ ${formatCurrency(price)}ØŸ`)) {await db.products.update(existingProduct.id, { price: price });} else {return;}} else {await db.products.add({ name, price });} await Promise.all([displaySavedProducts(), updateCounters()]); nameInput.value = ''; priceInput.value = ''; nameInput.focus();} catch (error) {console.error("Error saving product:", error); alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬.');}}
    async function deleteProduct(id) { if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) { await db.products.delete(id); await Promise.all([displaySavedProducts(), updateCounters()]); } }
    function handleProductListSearch(e) {const query = e.target.value.toLowerCase().trim(); const filteredProducts = productListCache.filter(p => p.name.toLowerCase().includes(query)); renderProductsList(filteredProducts);}
    function renderProductsList(products) {const container = document.getElementById('productsListContainer'); container.innerHTML = ''; if (products.length === 0) {container.innerHTML = `<p style="text-align:center;color:var(--text-light);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«.</p>`; return;} const table = document.createElement('table'); table.style.width = '100%'; table.style.borderCollapse = 'collapse'; table.innerHTML = `<thead><tr style="background:var(--primary-dark); color:white;"><th style="padding:10px;">Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø­Ø°Ù</th></tr></thead><tbody>${products.map(p => `<tr><td style="padding:8px; border-bottom:1px solid #eee;">${p.name}</td><td style="padding:8px; border-bottom:1px solid #eee; color:var(--success-color); font-weight:bold;">${formatCurrency(p.price)}</td><td style="padding:8px; border-bottom:1px solid #eee; text-align:center;"><button class="btn danger" style="padding:5px 10px;" onclick="deleteProduct(${p.id})">ğŸ—‘ï¸</button></td></tr>`).join('')}</tbody>`; container.appendChild(table);}
    async function displaySavedProducts() {productListCache = await db.products.orderBy('name').toArray(); renderProductsList(productListCache);}
    function updateLineTotal() { const q = parseFloat(document.getElementById('quantity').value) || 0, p = parseFloat(document.getElementById('price').value) || 0; document.getElementById('lineTotal').textContent = formatCurrency(q * p); }
    function handleAddOrUpdateClick() {if (isEditingItem) {updateItemInInvoice();} else {addItemFromForm();}}
    async function addItemFromForm() {const productName = document.getElementById('productName').value.trim(); const quantity = parseFloat(document.getElementById('quantity').value) || 0; const price = parseFloat(document.getElementById('price').value) || 0; const notes = document.getElementById('itemNotes').value.trim(); if (!productName || quantity <= 0 || price <= 0) return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ ÙˆÙƒÙ…ÙŠØ© ÙˆØ³Ø¹Ø± ØµØ­ÙŠØ­.'); let productInDb = await db.products.where('name').equalsIgnoreCase(productName).first(); if (!productInDb) { await db.products.add({ name: productName, price: price }); await displaySavedProducts(); await updateCounters(); } else if (productInDb.price !== price) { await db.products.update(productInDb.id, { price: price }); await displaySavedProducts(); } currentInvoice.items.push({ product: productName, quantity, price, total: quantity * price, notes }); displayCurrentInvoiceItems(); updateFinalTotals(); ['productName', 'quantity', 'price', 'itemNotes'].forEach(id => document.getElementById(id).value = ''); document.getElementById('lineTotal').textContent = '0'; document.getElementById('productName').focus();}
    function editItem(index) {const item = currentInvoice.items[index]; if (!item) return; isEditingItem = true; editingItemIndex = index; document.getElementById('productName').value = item.product; document.getElementById('quantity').value = item.quantity; document.getElementById('price').value = item.price; document.getElementById('itemNotes').value = item.notes || ''; updateLineTotal(); document.getElementById('addItemBtn').textContent = 'âœï¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬'; window.scrollTo(0, document.getElementById('productName').offsetTop);}
    function updateItemInInvoice() {const productName = document.getElementById('productName').value.trim(); const quantity = parseFloat(document.getElementById('quantity').value) || 0; const price = parseFloat(document.getElementById('price').value) || 0; const notes = document.getElementById('itemNotes').value.trim(); if (!productName || quantity <= 0 || price <= 0) return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ ÙˆÙƒÙ…ÙŠØ© ÙˆØ³Ø¹Ø± ØµØ­ÙŠØ­.'); currentInvoice.items[editingItemIndex] = { product: productName, quantity, price, total: quantity * price, notes }; isEditingItem = false; editingItemIndex = null; displayCurrentInvoiceItems(); updateFinalTotals(); ['productName', 'quantity', 'price', 'itemNotes'].forEach(id => document.getElementById(id).value = ''); document.getElementById('lineTotal').textContent = '0'; document.getElementById('addItemBtn').textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„ÙØ§ØªÙˆØ±Ø©'; document.getElementById('productName').focus();}
    function removeItem(index) { currentInvoice.items.splice(index, 1); displayCurrentInvoiceItems(); updateFinalTotals(); }
    function updateFinalTotals() {const currentTotal = currentInvoice.items.reduce((s, i) => s + i.total, 0); const prevBal = parseFloat(document.getElementById('previousBalance').value) || 0; const payment = parseFloat(document.getElementById('paymentAmount').value) || 0; const remaining = (currentTotal + prevBal) - payment; currentInvoice.total = currentTotal; currentInvoice.previousBalance = prevBal; currentInvoice.payment = payment; document.getElementById('itemCount').textContent = formatCurrency(currentInvoice.items.length); document.getElementById('currentTotalAmount').textContent = `${formatCurrency(currentTotal)} Ø¯ÙŠÙ†Ø§Ø±`; document.getElementById('remainingAmount').textContent = `${formatCurrency(remaining)} Ø¯ÙŠÙ†Ø§Ø±`;}
    function displayCurrentInvoiceItems() {document.getElementById('itemsContainerWrapper').style.display = currentInvoice.items.length > 0 ? 'block' : 'none'; const container = document.getElementById('itemsContainer'); container.innerHTML = currentInvoice.items.map((item, i) => `<tr><td style="padding:8px; border-bottom:1px solid #eee;">${formatCurrency(i + 1)}</td><td style="text-align:right; padding:8px; border-bottom:1px solid #eee;">${item.product}</td><td style="padding:8px; border-bottom:1px solid #eee;">${item.quantity}</td><td style="padding:8px; border-bottom:1px solid #eee;">${formatCurrency(item.price)}</td><td style="padding:8px; border-bottom:1px solid #eee; font-weight:bold;">${formatCurrency(item.total)}</td><td style="padding:8px; border-bottom:1px solid #eee;">${item.notes || '-'}</td><td style="padding:8px; border-bottom:1px solid #eee;"><button class="btn success" style="padding:5px 10px;" onclick="editItem(${i})">âœï¸</button></td><td style="padding:8px; border-bottom:1px solid #eee;"><button class="btn danger" style="padding:5px 10px;" onclick="removeItem(${i})">ğŸ—‘ï¸</button></td></tr>`).join('');}
    async function saveOrUpdateInvoice() {const customerName = document.getElementById('customerName').value.trim(); if (!customerName) return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø²Ø¨ÙˆÙ†.'); if (currentInvoice.items.length === 0) return alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ ÙØ§ØªÙˆØ±Ø© ÙØ§Ø±ØºØ©.'); updateFinalTotals(); const data = { customer: customerName, date: document.getElementById('invoiceDate').value, ...currentInvoice }; if (currentEditingInvoiceId) { await db.invoices.update(currentEditingInvoiceId, data); alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!'); } else { await db.invoices.add(data); alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!'); } await Promise.all([displaySavedInvoices(), updateCounters()]); clearInvoice();}
    async function editInvoice(id) {const invoice = await db.invoices.get(id); if (!invoice) return; currentEditingInvoiceId = id; document.getElementById('customerName').value = invoice.customer; document.getElementById('invoiceDate').value = invoice.date; document.getElementById('previousBalance').value = invoice.previousBalance || ''; document.getElementById('paymentAmount').value = invoice.payment || ''; currentInvoice = { items: invoice.items, total: invoice.total, payment: invoice.payment, previousBalance: invoice.previousBalance, }; displayCurrentInvoiceItems(); updateFinalTotals(); document.getElementById('saveBtn').textContent = 'âœï¸ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ§ØªÙˆØ±Ø©'; switchTab('create', document.querySelector('.tab')); window.scrollTo(0, 0);}
    async function deleteInvoice(id) { if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ')) { await db.invoices.delete(id); await Promise.all([displaySavedInvoices(), updateCounters()]); } }
    function handleInvoiceSearch(e) {const query = e.target.value.toLowerCase().trim(); const filteredInvoices = allInvoicesCache.filter(inv => inv.customer.toLowerCase().includes(query)); renderInvoices(filteredInvoices);}
    function renderInvoices(invoices) {const list = document.getElementById('invoicesList'); list.innerHTML = ''; if (invoices.length === 0) { list.innerHTML = `<p style="text-align:center;color:var(--text-light);padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«.</p>`; return; } invoices.forEach(inv => {const grandTotal = (inv.total || 0) + (inv.previousBalance || 0); const remaining = grandTotal - (inv.payment || 0); const item = document.createElement('div'); item.className = 'invoice-item'; item.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:flex-start;"><div><strong>ğŸ‘¤ ${inv.customer}</strong><div style="font-size:0.9em; color:var(--text-light);">ğŸ“… ${inv.date}</div></div><div style="text-align:left;"><div style="font-weight:bold; color:var(--danger-color);">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${formatCurrency(remaining)}</div><small>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${formatCurrency(grandTotal)}</small></div></div><div class="invoice-actions"><button class="btn" style="background-color: var(--primary-color);" onclick="printInvoice(${inv.id})">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button><button class="btn" style="background-color: var(--accent-color); color: #000;" onclick="editInvoice(${inv.id})">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button><button class="btn danger" onclick="deleteInvoice(${inv.id})">ğŸ—‘ï¸ Ø­Ø°Ù</button></div>`; list.appendChild(item);});}
    async function displaySavedInvoices() {allInvoicesCache = await db.invoices.orderBy('id').reverse().toArray(); renderInvoices(allInvoicesCache);}
    function confirmClearInvoice() { if (currentInvoice.items.length > 0 && confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŸ')) clearInvoice(); else if (currentInvoice.items.length === 0) clearInvoice(); }
    function clearInvoice() {currentEditingInvoiceId = null; isEditingItem = false; editingItemIndex = null; ['customerName', 'previousBalance', 'paymentAmount', 'productName', 'quantity', 'price', 'itemNotes'].forEach(id => document.getElementById(id).value = ''); document.getElementById('invoiceDate').valueAsDate = new Date(); currentInvoice = { items: [], total: 0, payment: 0, previousBalance: 0 }; displayCurrentInvoiceItems(); updateFinalTotals(); document.getElementById('saveBtn').textContent = 'ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©'; document.getElementById('addItemBtn').textContent = 'â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„ÙØ§ØªÙˆØ±Ø©';}
    async function exportInvoices() {const invoices = await db.invoices.toArray(); if (invoices.length === 0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§."); const data = { invoices }; const dataStr = JSON.stringify(data, null, 2); const fileName = "invoices_backup_" + new Date().toISOString().slice(0, 10) + ".json"; await shareOrDownload(dataStr, fileName, 'application/json');}
    function importInvoices() { document.getElementById('import-invoices-file').click(); }
    function handleInvoiceImport(event) {const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => processInvoiceImport(e.target.result); reader.readAsText(file); event.target.value = '';}
    async function processInvoiceImport(dataStr) {if (!confirm("Ø³ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆÙ…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ù„Ù† ØªØªØ£Ø«Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return; try {const importedData = JSON.parse(dataStr); if (!importedData.invoices) throw new Error("Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­."); await db.transaction('rw', db.invoices, async () => {await db.invoices.clear(); await db.invoices.bulkAdd(importedData.invoices.map(i => { delete i.id; return i; }));}); await initializeApp(); alert("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!");} catch (error) { console.error('Import Error:', error); alert("ÙØ´Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù."); }}
    async function exportProducts() {const products = await db.products.toArray(); if (products.length === 0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§."); const data = { products }; const dataStr = JSON.stringify(data, null, 2); const fileName = "products_backup_" + new Date().toISOString().slice(0, 10) + ".json"; await shareOrDownload(dataStr, fileName, 'application/json');}
    function importProducts() { document.getElementById('import-products-file').click(); }
    function handleProductImport(event) {const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => processProductImport(e.target.result); reader.readAsText(file); event.target.value = '';}
    async function processProductImport(dataStr) {if (!confirm("Ø³ÙŠØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆÙ…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ù„Ù† ØªØªØ£Ø«Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙÙˆØ§ØªÙŠØ±. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) return; try {const importedData = JSON.parse(dataStr); if (!importedData.products) throw new Error("Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­."); await db.transaction('rw', db.products, async () => {await db.products.clear(); await db.products.bulkAdd(importedData.products.map(p => { delete p.id; return p; }));}); await initializeApp(); alert("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");} catch (error) { console.error('Import Error:', error); alert("ÙØ´Ù„ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù."); }}
    async function clearAllProducts() {if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§ØªØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.')) {await db.products.clear(); await displaySavedProducts(); await updateCounters(); alert('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª.');}}
    async function shareOrDownload(dataStr, fileName, mimeType) {if (window.plugins && window.plugins.socialsharing) {const blob = new Blob([dataStr], { type: mimeType }); const reader = new FileReader(); reader.onloadend = function() {const base64data = reader.result; window.plugins.socialsharing.share(`Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ: ${fileName}`, fileName, base64data, null, () => { console.log('ØªÙ…Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­'); }, (err) => { alert('ÙØ´Ù„Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©: ' + err); });}; reader.readAsDataURL(blob);} else {alert("Ù…ÙŠØ²Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© ØªØ¹Ù…Ù„ ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ. Ø³ÙŠØªÙ… Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù."); const blob = new Blob([dataStr], { type: mimeType }); try {const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = fileName; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);} catch(err) { console.error('Fallback download failed:', err); alert("ÙØ´Ù„ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù."); }}}
    async function shareCurrentInvoice() {if (currentInvoice.items.length === 0) return alert('ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù…Ø´Ø§Ø±ÙƒØªÙ‡Ø§.'); updateFinalTotals(); const customerName = document.getElementById('customerName').value.trim() || 'Ø²Ø¨ÙˆÙ†'; const remaining = (currentInvoice.total + currentInvoice.previousBalance) - currentInvoice.payment; let shareText = `ÙØ§ØªÙˆØ±Ø©: *${customerName}*\nØ§Ù„ØªØ§Ø±ÙŠØ®: ${document.getElementById('invoiceDate').value}\n------------------------------------\n`; currentInvoice.items.forEach(item => {let itemText = `${item.product} (${item.quantity} x ${formatCurrency(item.price)}) = *${formatCurrency(item.total)}*`; if (item.notes) { itemText += `\n   - _Ù…Ù„Ø§Ø­Ø¸Ø©: ${item.notes}_`; } shareText += itemText + '\n';}); shareText += `------------------------------------\nØ§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${formatCurrency(currentInvoice.total)}\nØ­Ø³Ø§Ø¨ Ø³Ø§Ø¨Ù‚: ${formatCurrency(currentInvoice.previousBalance)}\nØ§Ù„ÙˆØ§ØµÙ„: ${formatCurrency(currentInvoice.payment)}\n*Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${formatCurrency(remaining)}*\n`; if (window.plugins && window.plugins.socialsharing) {window.plugins.socialsharing.share(shareText);} else {navigator.clipboard.writeText(shareText).then(() => {alert('ØªÙ… Ù†Ø³Ø® ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ù„ØµÙ‚Ù‡Ø§ ÙÙŠ Ø£ÙŠ ØªØ·Ø¨ÙŠÙ‚.');}, () => {alert('ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„ÙØ§ØªÙˆØ±Ø©.');});}}

    // =========================================================================
    // ============== Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ÙˆØ§Ù„Ù…Ø¶Ù…ÙˆÙ†Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© (v4) ==============
    // =========================================================================
    async function printInvoice(invoiceId) {
        // Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±)
        const invoice = await db.invoices.get(invoiceId);
        if (!invoice) {
            console.error("ÙØ´Ù„Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø¨Ø§Ù„Ù…Ø¹Ø±Ù:", invoiceId);
            alert("Ø®Ø·Ø£: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©.");
            return;
        }

        const remaining = ((invoice.total || 0) + (invoice.previousBalance || 0)) - (invoice.payment || 0);
        const currentTime = formatTime(new Date());
        
        // Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø¨Ù†Ø§Ø¡ ÙƒÙˆØ¯ HTML ÙƒÙ€ "Ù†Øµ" Ø¹Ø§Ø¯ÙŠ (Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±)
        const printContent = `
        <!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><title>ÙØ§ØªÙˆØ±Ø© ${formatCurrency(invoice.id)}</title>
        <style>
            @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');
            @page { size: A4; margin: 10mm; }
            body { font-family: 'Tajawal', sans-serif; direction: rtl; margin: 0; padding: 0; font-size: 11pt; line-height: 1.4; color: #000; }
            .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 5px; margin-bottom: 10px; } .header h1 { margin: 0; font-size: 18pt; font-weight: bold; } .header p { margin: 2px 0; font-size: 10pt; }
            .details-section { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; font-size: 12pt; border-bottom: 1px dashed #666; margin-bottom: 10px; }
            .items-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; } .items-table thead { display: table-header-group; } .items-table th, .items-table td { border: 1px solid #999; padding: 5px; text-align: center; }
            .items-table tr { page-break-inside: avoid; } .items-table th { font-weight: bold; background-color: #f0f0f0; } .items-table .item-name { text-align: right; padding-right: 8px; }
            .footer { page-break-inside: avoid; padding-top: 15px; border-top: 2px solid #333; margin-top: 15px; }
            .summary-table { width: 50%; margin-left: auto; font-size: 12pt; border-collapse: collapse; } .summary-table td { padding: 4px 6px; } .summary-table .label { font-weight: bold; }
            .summary-table .final-amount td { font-weight: bold; font-size: 14pt; border-top: 1px solid #666; padding-top: 6px; }
        </style></head><body>
            <header class="header"><h1>Ù…Ø­Ù„Ø§Øª Ø§Ø¨Ùˆ Ø¬Ø¹ÙØ± Ø§Ù„Ø±Ø¯ÙŠÙ†ÙŠ</h1><p>Ø¬Ø¹ÙØ± Ø§Ù„Ø±Ø¯ÙŠÙ†ÙŠ: <strong>07731103122 | 07800379300</strong>  - Ø­Ø³ÙŠÙ† Ø§Ù„Ø±Ø¯ÙŠÙ†ÙŠ: <strong>07826342265</strong></p><p><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> Ø¨Ù„Ø¯Ø±ÙˆØ² - Ù…Ù‚Ø§Ø¨Ù„ Ù…Ø·Ø¹Ù… - Ø¨ØºØ¯Ø§Ø¯ - Ø¯Ø§Ø®Ù„ Ø§Ù„Ù‚ÙŠØµØ±ÙŠÙ‡</p></header>
            <section class="details-section"><div><strong>Ø§Ù„Ø²Ø¨ÙˆÙ†:</strong> ${invoice.customer}</div><div><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${invoice.date} | <strong>Ø§Ù„ÙˆÙ‚Øª:</strong> ${currentTime}</div></section>
            <main>
                <table class="items-table">
                    <thead><tr><th>Øª</th><th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead>
                    <tbody>${invoice.items.map((item, index) => `<tr><td>${index + 1}</td><td class="item-name">${item.product}</td><td>${item.quantity}</td><td>${formatCurrency(item.price)}</td><td>${formatCurrency(item.total)}</td><td>${item.notes || ''}</td></tr>`).join('')}</tbody>
                </table>
            </main>
            <footer class="footer">
                <table class="summary-table">
                    <tr><td class="label">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø©:</td><td>${formatCurrency(invoice.total || 0)}</td></tr>
                    <tr><td class="label">Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³Ø§Ø¨Ù‚:</td><td>${formatCurrency(invoice.previousBalance || 0)}</td></tr>
                    <tr><td class="label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙˆØ§ØµÙ„:</td><td>${formatCurrency(invoice.payment || 0)}</td></tr>
                    <tr class="final-amount"><td class="label">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</td><td>${formatCurrency(remaining)}</td></tr>
                </table>
            </footer>
        </body></html>`;

        // Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
        if (window.cordova && cordova.plugins && cordova.plugins.printer) {
            
            // ==========================[ Ø§Ù„Ø­Ù„ Ø§Ù„Ø¬Ø°Ø±ÙŠ Ù‡Ù†Ø§ ]==========================
            // Ù„Ù‚Ø¯ ØªÙ… Ø­Ø°Ù ÙƒÙ„ ÙƒÙˆØ¯ Ø§Ù„Ù€ "iframe" Ø§Ù„Ù…Ø¹Ù‚Ø¯ ÙˆØ§Ù„Ø°ÙŠ ÙƒØ§Ù† ÙŠØ³Ø¨Ø¨ ÙƒÙ„ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„.
            // Ø§Ù„Ø¢Ù†ØŒ Ù†Ù‚ÙˆÙ… Ø¨ØªÙ…Ø±ÙŠØ± Ù…ØªØºÙŠØ± "printContent" (Ø§Ù„Ø°ÙŠ Ù‡Ùˆ Ù†Øµ HTML) Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¶Ø§ÙØ©.
            // Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£ØµØ­ ÙˆØ§Ù„Ø£ÙƒØ«Ø± Ø§Ø³ØªÙ‚Ø±Ø§Ø±Ø§Ù‹ ÙˆÙ…Ø¨Ø§Ø´Ø±Ø©.
            // ======================================================================
            cordova.plugins.printer.print(printContent, {
                name: `ÙØ§ØªÙˆØ±Ø© ${invoice.id}`,
                orientation: 'portrait'
            }, function (res) {
                // Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ ÙŠØ¹Ù…Ù„ Ø¨Ø¹Ø¯ Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
                console.log(res ? 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨Ù†Ø¬Ø§Ø­' : 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
            });

        } else {
            // Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø³ÙŠØ¹Ù…Ù„ ÙƒØ¨Ø¯ÙŠÙ„ ÙÙŠ Ø­Ø§Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ù…ØªØµÙØ­ Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±
            alert("Ù…ÙŠØ²Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© ØªØ¹Ù…Ù„ ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ. Ø³ÙŠØªÙ… ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…ØªØµÙØ­.");
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus(); // Ø¶Ø±ÙˆØ±ÙŠ Ù„Ø¨Ø¹Ø¶ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª
            setTimeout(function(){ printWindow.print(); }, 500); // ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ· Ù„Ø¶Ù…Ø§Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        }
    }
</script>
</body>
</html>

